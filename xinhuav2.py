import time
import streamlit as st
from google import genai

# =====================================
# é é¢åŸºæœ¬è¨­å®šï¼ˆå¿…é ˆæ”¾æœ€å‰é¢ï¼‰
# =====================================
st.set_page_config(
    page_title="æ–°åŒ–æ•™æœƒ AI åŒå·¥",
    page_icon="â›ª",
    layout="centered"
)

# =====================================
# å®‰å…¨è®€å– API KEY
# =====================================
try:
    API_KEY = st.secrets["GEMINI_API_KEY"]
except Exception:
    st.error("è«‹åœ¨ Streamlit Cloud â†’ Settings â†’ Secrets è¨­å®š GEMINI_API_KEY")
    st.stop()

# åˆå§‹åŒ– Gemini Client
client = genai.Client(api_key=API_KEY)

# =====================================
# æ•™æœƒçŸ¥è­˜åº«
# =====================================
KNOWLEDGE_BASE = {

    "ç¦éŸ³é™ªè«‡":
    """ç¦éŸ³ 10 æ ¼åœ–ï¼š
    1 å‰µé€ 
    2 å¢®è½
    3 å¯©åˆ¤
    4 å¾‹æ³•
    5 åŸºç£
    6 æ•‘è´–
    7 å¾©æ´»
    8 ä¿¡å¿ƒ
    9 é‡ç”Ÿ
    10 æ°¸ç”Ÿ""",

    "é–€å¾’è£å‚™":
    """é–€å¾’ 12 æ ¼åœ–ï¼š
    1 ç”Ÿå‘½ä¸»æ¬Š
    2 è®€ç¶“éˆä¿®
    3 ç¦±å‘Šç”Ÿæ´»
    4 åœ˜å¥‘ç”Ÿæ´»
    5 è–æ½”ç”Ÿæ´»
    6 è¦‹è­‰åˆ†äº«
    7 äº‹å¥‰äººç”Ÿ
    8 å¥‰ç»ç”Ÿæ´»
    9 å±¬éˆçˆ­æˆ°
    10 å¤§ä½¿å‘½
    11 è‚¢é«”é€£çµ
    12 æ°¸æ†ç›¼æœ›""",

    "æ–°æœ‹å‹å°è¦½":
    """æ•™æœƒè³‡è¨Šï¼š
    ä¸»æ—¥èšæœƒï¼šé€±æ—¥ä¸Šåˆ 09:30
    åœ°é»ï¼šå°å—å¸‚æ–°åŒ–å€
    æ­¡è¿æ–°æœ‹å‹åƒåŠ """
}

# =====================================
# è§’è‰²è¨­å®š
# =====================================
ROLES = {

    "ç¦éŸ³é™ªè«‡":
    "ä½ æ˜¯æ–°åŒ–æ•™æœƒæº«æŸ”ã€æœ‰æ„›å¿ƒçš„ç¦éŸ³é™ªè«‡è€…ï¼Œè«‹ç”¨æº«æŸ”èˆ‡é—œæ‡·çš„èªæ°£å›ç­”ã€‚",

    "é–€å¾’è£å‚™":
    "ä½ æ˜¯æ–°åŒ–æ•™æœƒé–€å¾’è£å‚™åŠ©æ‰‹ï¼Œè«‹ç”¨é¼“å‹µèˆ‡é€ å°±çš„èªæ°£å›ç­”ã€‚",

    "æ–°æœ‹å‹å°è¦½":
    "ä½ æ˜¯æ–°åŒ–æ•™æœƒè¦ªåˆ‡çš„æ¥å¾…åŒå·¥ï¼Œè«‹ç†±æƒ…æ­¡è¿ä¸¦æ¸…æ¥šèªªæ˜ã€‚"
}

# =====================================
# Sidebar
# =====================================
with st.sidebar:

    st.title("â›ª æ–°åŒ–æ•™æœƒ AI åŒå·¥")

    role = st.radio(
        "è«‹é¸æ“‡æœäº‹æ¨¡å¼",
        ["ç¦éŸ³é™ªè«‡", "é–€å¾’è£å‚™", "æ–°æœ‹å‹å°è¦½"]
    )

    st.markdown("---")

    st.info(f"ç›®å‰æ¨¡å¼ï¼š{role}")

    st.caption("ç³»çµ±ä¸æœƒä¿å­˜å°è©±ç´€éŒ„")

# =====================================
# ä¸»ç•«é¢
# =====================================
st.title("â›ª æ–°åŒ–æ•™æœƒ AI åŒå·¥")

st.write("æ­¡è¿æ‚¨ï¼Œè«‹è¼¸å…¥æ‚¨çš„å•é¡Œ ğŸ™")

st.markdown("---")

# =====================================
# é˜²æ­¢ä½¿ç”¨è€…ç‹‚æŒ‰ï¼ˆé¿å…è²»ç”¨æš´å¢ï¼‰
# =====================================
if "last_call_time" not in st.session_state:
    st.session_state.last_call_time = 0

# =====================================
# èŠå¤©è¼¸å…¥
# =====================================
user_input = st.chat_input("è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ...")

if user_input:

    # é™åˆ¶é »ç‡
    if time.time() - st.session_state.last_call_time < 2:
        st.warning("è«‹ç¨å€™å†è©¢å• ğŸ™")
        st.stop()

    st.session_state.last_call_time = time.time()

    # é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
    with st.chat_message("user"):
        st.write(user_input)

    # AI å›è¦†å€å¡Š
    with st.chat_message("assistant"):

        with st.spinner("åŒå·¥æ­£åœ¨æ€è€ƒä¸­..."):

            try:

                # çµ„åˆ Promptï¼ˆæœ€ç©©å®šæ–¹å¼ï¼‰
                full_prompt = f"""
è§’è‰²è¨­å®šï¼š
{ROLES[role]}

èƒŒæ™¯çŸ¥è­˜ï¼š
{KNOWLEDGE_BASE[role]}

ä½¿ç”¨è€…å•é¡Œï¼š
{user_input}

è«‹ç”¨æº«æŸ”ã€è‡ªç„¶ã€ç¬¦åˆè§’è‰²çš„æ–¹å¼å›ç­”ã€‚
"""

                # â­ ä½¿ç”¨æœ€æ–°æ¨¡å‹ gemini-2.0-flash
                response = client.models.generate_content(
                    model="gemini-2.0-flash",
                    contents=full_prompt
                )

                # å®‰å…¨å–å¾—å›æ‡‰
                reply = getattr(response, "text", None)

                if reply:
                    st.write(reply)
                else:
                    st.warning("ç›®å‰ç„¡æ³•å–å¾—å›æ‡‰ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚")

            except Exception as e:

                st.error("ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦")

                with st.expander("éŒ¯èª¤è©³æƒ…"):
                    st.code(str(e))

else:

    st.write("ğŸ™ å¹³å®‰ï¼æ­¡è¿è©¢å•ä»»ä½•å•é¡Œ")